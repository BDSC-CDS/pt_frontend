pipeline {
    agent {
        docker {
            image 'docker:latest'
        }
    }
    environment {
	    E_MAIL_INFORM = 'paloma.cito@chuv.ch'
        COMPOSE_PROJECT_NAME = 'my-app'
	}

    stages {
        stage('Cleanup and checkout') {
            steps {
                cleanWs()
                checkout scm
            }
        }

        stage('Build') {
            steps {
                sh 'docker-compose build'
            }
        }

        stage('Run Tests') {
            steps {
                sh 'sleep 20'
                // sh 'docker-compose run --rm app pytest -v'
            }
        }

        stage('Stop and remove container') {
            steps {
                sh 'docker-compose down'
            }
        }

        stage("User notification?") {
            when {
                expression {
                    return params.SEND_EMAIL
                }
            }
            steps {
                emailext subject: "${env.JOB_NAME} - build SUCCESS (${env.BUILD_NUMBER})", body: "${env.BUILD_URL}console", to: "${E_MAIL_INFORM}"
            }
        }
    }
    post {
        always {
            // always (cannot be empty)
            echo 'Email notification'
            //junit '../tests/result.xml' TODO
         }

        failure {
             // only in case of failure
             emailext subject: "${env.JOB_NAME} - build FAILURE (${env.BUILD_NUMBER})", body: "${env.BUILD_URL}console", to: "${E_MAIL_INFORM}";
         }
        unstable {
             // only if the run was marked as unstable
             emailext subject: "${env.JOB_NAME} - build UNSTABLE (${env.BUILD_NUMBER})", body: "${env.BUILD_URL}console", to: "${E_MAIL_INFORM}";
         }
    }
}
